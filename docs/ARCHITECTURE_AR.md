# تحليل معماري وخطة تحويل Clean Architecture

## ملخص الوضع الحالي
- المسارات (Routes) تجمع بين منطق العمل والاستعلامات وقواعد الصلاحيات في نفس الملف.
- الاعتماد المباشر على نماذج قاعدة البيانات داخل الواجهات يجعل الاختبار وإعادة الاستخدام أصعب.
- استعلامات القراءة تجمع بيانات العناصر عبر استعلامات متكررة لكل طلب (N+1).

## الهدف
فصل المسؤوليات إلى طبقات مستقلة بحيث:
- تصبح منطق الأعمال قابل للاختبار بدون قاعدة بيانات.
- تُعزل تفاصيل البنية التحتية (SQLAlchemy/DB) عن المنطق.
- يسهل توسعة النظام إلى أحجام استخدام كبيرة (100k مستخدم).

## الطبقات المقترحة (Clean Architecture)
1. **Domain (النواة)**
   - كيانات ووحدات قيمة وأخطاء نطاقية.
2. **Application (حالات الاستخدام)**
   - منطق الأعمال عبر Use Cases.
3. **Infrastructure (المنافذ)**
   - تطبيقات مستودعات الوصول للبيانات وأي تكاملات خارجية.
4. **Presentation (الواجهة)**
   - المسارات/الـ API ومخططات الطلب/الرد.

## ما تم تنفيذه مبدئيًا
تم عزل وحدة "طلبات المواد" إلى طبقات نظيفة:
- `backend/app/requests/domain`
- `backend/app/requests/application`
- `backend/app/requests/infrastructure`
- `backend/app/requests/presentation`

وتم ربط المسار الخاص بإنشاء الطلبات واستعراضها بهذه الطبقات.

## تحسينات التوسع لـ 100k مستخدم
### قاعدة البيانات والاستعلامات
- **تقسيم النتائج (Pagination)** في مسار استعراض الطلبات للحد من سحب البيانات.
- **تجميع الاستعلامات** لعناصر الطلبات بدلاً من N+1 عبر استعلام واحد.
- **فهارس مركبة** موجودة ويجب مراجعتها مع أنماط الاستعلام الفعلية.
- **قراءات كثيفة**: التحضير لقراءات عبر Read Replicas عند الحاجة.

### الأداء والبنية التحتية
- **تجميع الاتصالات (Connection Pooling)** مضبوط ومراقب وفق الحمل.
- **Caching** للبيانات المرجعية (المشاريع/المستخدمين/الكتالوج).
- **Rate Limiting** لحماية الـ API.
- **Observability** (metrics + tracing) لمراقبة الأداء.

### المعالجة غير المتزامنة
- **Queues/Workers** للمهام الثقيلة (التقارير، الإشعارات، التوليد).

## خطة ترحيل باقي الوحدات
1. نقل وحدات الطلبات والميزانيات إلى طبقات منفصلة.
2. توحيد أخطاء النطاق وإرجاعها عبر الطبقة التقديمية.
3. استبدال منطق العمل المتناثر بحالات استخدام واضحة.

## الاختبارات الحرجة
تم إضافة اختبارات وحدات لحالات الاستخدام الرئيسية:
- إنشاء طلب مواد.
- فرض الصلاحيات.
- ترقيم النتائج وتحديد الصلاحيات في الاستعراض.
