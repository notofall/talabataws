<analysis>**original_problem_statement:**
The user initiated a major architectural change, requesting to migrate the entire application from MongoDB to a cloud-hosted PostgreSQL database (specifically PlanetScale) to support a larger, enterprise-level scale (>200 users).

Following the successful migration, the user requested a new set of features and role adjustments:
1.  **New System Admin Role**: Create a new top-level System Admin role. The first user created in the system should have this role.
2.  **Permission Restructuring**:
    *   Move Backup/Restore and Data Cleaning functionalities from the Procurement Manager to the new System Admin.
    *   Restrict User Management (add/edit/delete users) to the System Admin only.
    *   The Procurement Manager should retain all other current permissions.
3.  **System Admin Dashboard**: Create a new dashboard for the System Admin.
4.  **Company Branding**: Allow the System Admin to upload a company logo and define custom text to appear in the header and footer of all generated PDF documents.
5.  **Backup/Restore**: Implement a full system data backup (export) and restore (import) functionality, managed by the System Admin.
6.  **Bug Fixes & UI Enhancements**:
    *   Fix an issue where the View Purchase Order button does not display the correct PO number and request number.
    *   Enhance the PDF export functionality with more filters: by Project, Supervisor, Engineer, and approval type (GM-approved vs. Procurement-approved).
    *   Address a UI issue where an Approve All button appears incorrectly after issuing a purchase order.
    *   Add a new filter to the Procurement Manager's dashboard to show orders Pending GM Approval.

**User's preferred language**: Arabic (العربية)

**what currently exists?**
The application has been completely migrated from MongoDB to PostgreSQL, hosted on PlanetScale. All backend APIs have been rewritten using SQLAlchemy and now operate under the  prefix. The entire React frontend has been updated to consume these new PostgreSQL APIs. The authentication flow, user roles, and all core business logic (projects, suppliers, requests, purchase orders, reports) are fully functional on the new PostgreSQL database.

**Last working item**:
-   **Last item agent was working**: Implementing the new System Admin role and restructuring user permissions as requested. The agent created the new role in the backend enum, updated the user creation/management APIs to enforce the new permissions, created a new route file () for admin-specific functions, and created the initial placeholder file for the frontend dashboard ().
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: both
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1: Complete System Admin Feature Set (P0)**
    -   **Attempted fixes**: The foundational backend and frontend files have been created, and permission checks on existing auth routes have been updated.
    -   **Next debug checklist**:
        1.  Implement the backup (export) and restore (import) logic in .
        2.  Implement the company branding (logo upload, custom text) settings API in .
        3.  Build the complete UI in  to manage users, trigger backups/restores, and configure company branding.
        4.  Remove the now-redundant UI elements for user management and data cleaning from .
    -   **Why fix this issue and what will be achieved with the fix?**: This will fulfill the user's primary request for a new administrative role with exclusive control over critical system functions.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: None

**In progress Task List**:
None other than the issue listed above.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   **P0: Fix PO/Request Number Display**: Investigate why the View Purchase Order button shows incorrect numbers and fix the data fetching or display logic in the relevant frontend component.
    -   **P0: Enhance PDF Export Filters**: Modify the backend report generation API and the frontend UI to allow filtering PDF exports by Project, Supervisor, Engineer, and PO approval type.
    -   **P0: Fix Approve All UI Bug**: Analyze the frontend state management in  to prevent the Approve All button from appearing incorrectly after a PO is created.
    -   **P0: Add Pending GM Approval Filter**: Add a new filter button/tab to  and update the data fetching logic to filter for purchase orders with the  status.
-   **Future Tasks**:
    -   **P1: Implement Audit Trail**: Integrate the existing  function into all new PostgreSQL-based workflows.
    -   **P2: Implement File Attachments**: Build the frontend for file uploads for attaching quotations to purchase orders.
    -   **P3: Advanced Reporting & Analytics**: Enhance the UI for the existing cost savings and supplier performance reports.
    -   **P4: Enable Email Notifications**: This remains blocked on the user providing a SendGrid API key.
    -   **P5: Code Cleanup**: Remove all legacy MongoDB-related code from  and other backend files.

**Completed work in this session**
-   **Full-Stack Database Migration (MongoDB → PostgreSQL)**:
    -   Successfully migrated the entire backend from MongoDB to a PlanetScale-hosted PostgreSQL database.
    -   Created a complete SQLAlchemy ORM layer for all 15 database tables in .
    -   Rewrote all 59+ backend APIs to use PostgreSQL, organized into new modular route files (e.g., , ).
    -   Updated the entire React frontend (, all dashboard pages) to use the new  endpoints.
    -   Verified the full functionality of the application on the new database via manual and screenshot testing.

**Earlier issues found/mentioned but not fixed**
None.

**Known issue recurrence from previous fork**
None.

**Code Architecture**


**Key Technical Concepts**
-   **Database Migration**: Full-stack migration from a NoSQL (MongoDB) to a relational (PostgreSQL) database.
-   **Cloud Database**: Integration with a managed cloud database service (PlanetScale).
-   **Backend (FastAPI & SQLAlchemy)**: Refactoring a large monolithic application into modular, maintainable routes. Using SQLAlchemy as the ORM for all database interactions.
-   **Frontend (React)**: Global state modification () to retarget all API calls to a new backend prefix. Verifying and updating API call sites across multiple complex dashboard components.
-   **Role-Based Access Control (RBAC)**: Introducing a new  role and refactoring API endpoint dependencies to enforce stricter permissions.

**key DB schema**
-   ****: The  enum now includes . The first user created will have this role.
-   **All other tables**: (projects, suppliers, purchase_orders, etc.) are now managed by SQLAlchemy models defined in .

**changes in tech stack**
-   **Database**: MongoDB has been fully replaced by **PostgreSQL (PlanetScale)**.
-   **Backend Libraries**: **SQLAlchemy**, **Alembic**, **psycopg2-binary**, and  have been added to the stack.

**All files of reference**
-   
-   
-   All files in 
-   
-   
-   
-   
-   
-   
-   

**Areas that need refactoring**:
-   The main  file still contains all the original, now-unused MongoDB logic. This code should be removed to avoid confusion and reduce the file size.

**key api endpoints**
All new and active endpoints are prefixed with . Examples:
-   
-   
-   
-   
-   
-   
-    (New routes being built)

**Critical Info for New Agent**
-   **Language**: You MUST respond to the user in **Arabic (العربية)**.
-   **Database**: The application is now **100% on PostgreSQL**. All MongoDB-related code in the backend is legacy and should be ignored for new features and eventually removed. Do not attempt to connect to or use MongoDB.
-   **API Prefix**: All current and future backend API calls must use the  prefix.
-   **Current Focus**: The immediate priority is to complete the System Admin role and dashboard, followed by the list of bug fixes and UI enhancements requested by the user.

**documents and test reports created in this job**
-    (updated multiple times to reflect migration progress).

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: Confirmed they want to proceed with the System Admin feature set. (COMPLETED)
2.  **User**: Provided clarification on System Admin requirements (backup/restore, permissions, branding). (COMPLETED)
3.  **Agent**: Asked for clarification on the new feature requests. (COMPLETED)
4.  **User**: Provided a new, large list of requirements including a System Admin role, permission changes, branding, and several bug fixes/UI tweaks. (PENDING IMPLEMENTATION)
5.  **User**: Continue (after frontend migration was completed). (COMPLETED)
6.  **Agent**: Finished the frontend migration to PostgreSQL. (COMPLETED)
7.  **User**: Continue (after backend PO/Reports migration was completed). (COMPLETED)
8.  **Agent**: Finished migrating backend POs, settings, and reports. (COMPLETED)
9.  **User**: Continue (after backend Auth/Projects migration was completed). (COMPLETED)
10. **User**: Confirmed they want PostgreSQL as the database. (COMPLETED)

**Project Health Check:**
-   **Broken**: None
-   **Mocked**: SendGrid email notifications (pending user API key).

**3rd Party Integrations**
-   **PostgreSQL (PlanetScale)**: The primary database for the application.
-   **SQLAlchemy / Alembic / psycopg2-binary**: Backend libraries for interacting with PostgreSQL.
-   **SendGrid**: Integrated but inactive, requires user-provided API keys.
-   **openpyxl**: Used for Excel/CSV operations on the backend.

**Testing status**
-   **Testing agent used after significant changes**: NO (Agent performed manual testing of the migration).
-   **Troubleshoot agent used after agent stuck in loop**: NO.
-   **Test files created**: None.
-   **Known regressions**: None identified, but the user has reported new issues post-migration.

**Credentials to test flow:**
| Role | Email | Password |
| :--- | :--- | :--- |
| System Admin (new first user) |  (example) |  |
| Procurement Manager |  |  |
| General Manager |  |  |
| Engineer |  |  |
| Site Supervisor |  |  |

**What agent forgot to execute**
The agent has not yet cleaned up the old MongoDB code from  after the migration. This is a technical debt item that should be addressed to improve maintainability.</analysis>
