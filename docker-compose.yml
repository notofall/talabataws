# ============================================
# Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ - Docker Compose
# Material Requests Management System
# ============================================
#
# ğŸ“‹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:
# 1. Ø§Ù†Ø³Ø® .env.example Ø¥Ù„Ù‰ .env ÙˆØ¹Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ…
# 2. Ø´ØºÙ‘Ù„: docker-compose up -d --build
# 3. Ù„Ù„ØªØ­Ø¯ÙŠØ«: ./deploy.sh
#
# ============================================

services:
  # Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª PostgreSQL
  postgres:
    image: postgres:14-alpine
    container_name: talabat_db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin123}
      POSTGRES_DB: ${POSTGRES_DB:-talabat_db}
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-talabat_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - talabat_network

  # Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: talabat_backend
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-talabat_db}
      - POSTGRES_USER=${POSTGRES_USER:-admin}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-admin123}
      - POSTGRES_SSLMODE=disable
      - SECRET_KEY=${SECRET_KEY:-my-super-secret-key-for-jwt-tokens}
    volumes:
      - ./backend/data:/app/data
    ports:
      - "${BACKEND_PORT:-8001}:8001"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - talabat_network

  # Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: talabat_frontend
    environment:
      - REACT_APP_BACKEND_URL=${BACKEND_URL:-http://localhost:8001}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - talabat_network

networks:
  talabat_network:
    driver: bridge
